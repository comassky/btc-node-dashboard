<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Node RPC Dashboard</title>

    <link rel="icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Configuration Tailwind pour utiliser les variables CSS et le mode sombre
        tailwind.config = {
            darkMode: 'class', // Permet de basculer avec une classe 'dark' sur <html>
            theme: {
                extend: {
                    colors: {
                        // Les couleurs sont tirées des variables CSS dans dashboard.css
                        'bg-app': 'var(--bg-app)',
                        'bg-card': 'var(--bg-card)',
                        'border-strong': 'var(--border-strong)',
                        'text-primary': 'var(--text-primary)',
                        'text-secondary': 'var(--text-secondary)',
                        'accent': 'var(--accent)',
                        'status-success': 'var(--status-success)',
                        'status-error': 'var(--status-error)',
                        'status-warning': 'var(--status-warning)',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>

<body class="bg-bg-app text-text-primary leading-relaxed transition-colors duration-300">

<div id="app" class="p-2 md:p-6">
    <button @click="toggleDarkMode"
            class="fixed top-4 right-4 z-50 p-3 rounded-full bg-bg-card border border-border-strong text-text-primary text-xl shadow-lg hover:bg-border-strong/50 transition-all duration-200"
            title="Basculer Mode Clair/Foncé">
        <i :class="isDarkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
    </button>

    <div class="flex justify-center mb-12 mt-4 sm:mt-0">
        <h1
                class="text-accent text-3xl md:text-5xl font-extralight tracking-widest uppercase text-center">
            <i class="fab fa-bitcoin mr-2"></i> Bitcoin Node Dashboard
        </h1>
    </div>


    <div class="status-bar is-mobile flex justify-center items-center gap-4 sm:gap-10 p-5 md:p-6 mb-10 rounded-xl font-medium shadow-2xl transition-all duration-300 ease-in-out"
         :class="{
            'bg-status-success/10 border border-status-success text-status-success': isConnected && rpcConnected,
            'bg-status-error/10 border border-status-error text-status-error pulse-error': !isConnected || !rpcConnected
        }">
            <span :title="isConnected ? 'WebSocket link is active and open' : 'WebSocket disconnected. Retrying connection...'"
                  class="flex items-center">
                <i class="fas fa-network-wired mr-2 text-xl"></i> WebSocket: {{ isConnected ? 'CONNECTED' : 'DISCONNECTED' }}
            </span>
        <span :title="rpcConnected ? 'Node is responding to RPC commands' : 'RPC connection lost or not yet established'"
              class="flex items-center">
                <i class="fas fa-server mr-2 text-xl"></i> Node RPC: {{ rpcConnected ? 'ONLINE' : 'OFFLINE' }}
            </span>
        <p v-if="errorMessage" class="text-sm font-light mt-1 pt-1 sm:border-t-0 sm:pt-0">
            <i class="fas fa-exclamation-circle mr-2"></i> {{ errorMessage }}
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <div class="lg:col-span-2 mb-5" v-if="rpcConnected">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

                <div
                        class="stat-card bg-bg-card p-6 rounded-xl shadow-lg border-l-4 border-status-success hover:shadow-2xl hover:border-accent transition duration-300 transform hover:-translate-y-0.5 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <div class="icon text-3xl text-status-success"><i class="fas fa-user-friends"></i></div>
                        <div class="label text-xs uppercase text-text-secondary font-medium">Total Peers</div>
                    </div>
                    <div class="value text-5xl font-light text-text-primary">{{ stats.totalPeers }}</div>
                    <div class="detail mt-2 pt-2 border-t border-border-strong text-sm text-text-secondary font-light">
                        <p class="mb-1"><i class="fas fa-sign-in-alt mr-1"></i> Inbound: {{ stats.inboundCount }}</p>
                        <p class="mb-1"><i class="fas fa-sign-out-alt mr-1"></i> Outbound: {{ stats.outboundCount }}</p>
                    </div>
                </div>

                <div
                        class="stat-card bg-bg-card p-6 rounded-xl shadow-lg border-l-4 border-status-warning hover:shadow-2xl hover:border-accent transition duration-300 transform hover:-translate-y-0.5 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <div class="icon text-3xl text-status-warning"><i class="fas fa-cubes"></i></div>
                        <div class="label text-xs uppercase text-text-secondary font-medium">Current Block</div>
                    </div>
                    <div class="value text-5xl font-light text-text-primary"
                         :title="'Current height of the ' + blockchain.chain + ' blockchain'">{{ blockchain.blocks }}
                    </div>

                    <div class="detail mt-2 pt-2 border-t border-border-strong text-sm text-text-secondary font-light">
                        <p class="mb-1"><i class="fas fa-list-ol mr-1"></i> Headers: <span
                                class="font-bold text-text-primary">{{ blockchain.headers }}</span></p>
                        <p class="mb-1"><i class="far fa-clock mr-1"></i> Time: <span
                                class="font-bold text-text-primary">{{ formatTimeSince(block.time) }} ago</span></p>
                        <p class="mb-1"><i class="fas fa-exchange-alt mr-1"></i> Tx Count: <span
                                class="font-bold text-text-primary">{{ block.ntx }}</span></p>
                    </div>
                </div>

                <div
                        class="stat-card bg-bg-card p-6 rounded-xl shadow-lg border-l-4 border-accent hover:shadow-2xl hover:border-accent transition duration-300 transform hover:-translate-y-0.5 flex flex-col gap-3 lg:col-span-2">
                    <div class="flex justify-between items-center">
                        <div class="icon text-3xl text-accent"><i class="fas fa-hard-hat"></i></div>
                        <div class="label text-xs uppercase text-text-secondary font-medium">Node Details</div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mt-2">
                        <div class="min-w-0 flex-shrink">
                            <div class="value text-2xl font-bold text-text-primary truncate"
                                 :title="cleanedSubversion">{{ cleanedSubversion }}</div>
                            <div class="detail text-sm text-text-secondary font-light">Protocol v{{ node.protocolVersion }}
                            </div>
                        </div>

                        <div class="text-left sm:text-right mt-3 sm:mt-0 flex-shrink-0">
                            <div class="value text-2xl font-bold text-text-primary"
                                 title="Time elapsed since node started">{{ upTime }}</div>
                            <div class="detail text-sm text-text-secondary font-light">Uptime</div>
                        </div>
                    </div>
                    <div class="detail mt-3 pt-3 border-t border-border-strong text-sm text-text-secondary">
                        <p class="mb-1">
                            <i class="fas fa-shield-alt mr-1 text-status-success"></i> Verification Progress:
                            <span class="font-bold text-text-primary ml-1">{{ (blockchain.verificationProgress *
                                    100).toFixed(4) }}%</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-bg-card p-6 rounded-xl shadow-2xl lg:col-span-2" v-else-if="isConnected && !rpcConnected">
            <p class="text-center text-text-secondary text-lg">
                <i class="fas fa-spinner fa-spin mr-2"></i> Connecting to node RPC...
            </p>
        </div>

        <div class="data-section bg-bg-card p-6 rounded-xl shadow-2xl lg:col-span-2" v-if="rpcConnected">
            <h2 class="text-2xl font-medium mb-6"><i class="fas fa-chart-pie mr-2 text-accent"></i> Peer Software Distribution</h2>

            <div class="flex flex-col md:flex-row gap-8 mt-4">

                <div class="sub-card flex-1 p-0 flex flex-col gap-4 border border-border-strong rounded-lg p-4">
                    <h4
                            class="text-lg font-bold uppercase text-center pb-2 border-b-2 border-status-success tracking-wider text-status-success">
                        <i class="fas fa-arrow-alt-circle-down mr-1"></i> Inbound Peers ({{ stats.inboundCount }})
                    </h4>
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="chart-container">
                            <canvas ref="inboundChartCanvas"></canvas>
                        </div>
                    </div>
                </div>

                <div class="sub-card flex-1 p-0 flex flex-col gap-4 border border-border-strong rounded-lg p-4">
                    <h4
                            class="text-lg font-bold uppercase text-center pb-2 border-b-2 border-accent tracking-wider text-accent">
                        <i class="fas fa-arrow-alt-circle-up mr-1"></i> Outbound Peers ({{ stats.outboundCount }})
                    </h4>
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="chart-container">
                            <canvas ref="outboundChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-section bg-bg-card p-6 rounded-xl shadow-2xl lg:col-span-2" v-if="rpcConnected">
            <h2 class="text-2xl font-medium mb-6"><i class="fas fa-table mr-2 text-accent"></i> Connection Details</h2>

            <h4 class="text-xl font-medium mt-4 border-b border-border-strong pb-2 text-status-success">Inbound Peers ({{ inbound_peers.length }})</h4>
            <div class="peer-table-wrapper border border-border-strong rounded-lg mt-4 shadow-inner">
                <table class="peer-table w-full text-sm">
                    <thead>
                    <tr class="bg-border-strong/50">
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">ID</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Address</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Software (SubVer)</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Version</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Time Offset</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Connection Time</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Network</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Type</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Ping</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase"><i
                                class="fas fa-arrow-down text-status-success"></i> Received</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase"><i
                                class="fas fa-arrow-up text-accent"></i> Sent</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="peer in inbound_peers" :key="'inbound-' + peer.id"
                        class="border-b border-border-strong/70 hover:bg-bg-card/70 transition duration-150">
                        <td class="p-4 font-light">{{ peer.id }}</td>
                        <td class="p-4 font-light" :title="peer.addr">{{ peer.addr }}</td>
                        <td class="p-4 font-light" :title="peer.subver">{{ peer.subver || '[Empty]' }}</td>
                        <td class="p-4 font-light">{{ peer.version }}</td>
                        <td class="p-4 font-light">{{ formatTimeOffset(peer.timeoffset) }}</td>
                        <td class="p-4 font-light">{{ formatTimeSince(peer.conntime) }} ago</td>
                        <td class="p-4 font-light">{{ peer.network || 'N/A' }}</td>
                        <td class="p-4 font-medium text-status-success"
                            :title="'Connection type: ' + peer.connection_type">{{ peer.connection_type }}</td>
                        <td class="p-4 font-light">{{ formatPing(peer.minping) }}</td>
                        <td class="p-4 font-light" :title="peer.bytesrecv + ' Bytes'">{{ formatBytes(peer.bytesrecv) }}
                        </td>
                        <td class="p-4 font-light" :title="peer.bytessent + ' Bytes'">{{ formatBytes(peer.bytessent) }}
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h4 class="text-xl font-medium mt-8 border-b border-border-strong pb-2 text-accent">Outbound Peers ({{ outbound_peers.length }})</h4>
            <div class="peer-table-wrapper border border-border-strong rounded-lg mt-4 shadow-inner">
                <table class="peer-table w-full text-sm">
                    <thead>
                    <tr class="bg-border-strong/50">
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">ID</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Address</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Software (SubVer)</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Version</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Time Offset</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Connection Time</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Network</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Type</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase">Ping</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase"><i
                                class="fas fa-arrow-down text-status-success"></i> Received</th>
                        <th class="p-4 text-left font-semibold text-text-secondary uppercase"><i
                                class="fas fa-arrow-up text-accent"></i> Sent</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="peer in outbound_peers" :key="'outbound-' + peer.id"
                        class="border-b border-border-strong/70 hover:bg-bg-card/70 transition duration-150">
                        <td class="p-4 font-light">{{ peer.id }}</td>
                        <td class="p-4 font-light" :title="peer.addr">{{ peer.addr }}</td>
                        <td class="p-4 font-light" :title="peer.subver">{{ peer.subver || '[Empty]' }}</td>
                        <td class="p-4 font-light">{{ peer.version }}</td>
                        <td class="p-4 font-light">{{ formatTimeOffset(peer.timeoffset) }}</td>
                        <td class="p-4 font-light">{{ formatTimeSince(peer.conntime) }} ago</td>
                        <td class="p-4 font-light">{{ peer.network || 'N/A' }}</td>
                        <td class="p-4 font-medium text-accent"
                            :title="'Connection type: ' + peer.connection_type">{{ peer.connection_type }}</td>
                        <td class="p-4 font-light">{{ formatPing(peer.minping) }}</td>
                        <td class="p-4 font-light" :title="peer.bytesrecv + ' Bytes'">{{ formatBytes(peer.bytesrecv) }}
                        </td>
                        <td class="p-4 font-light" :title="peer.bytessent + ' Bytes'">{{ formatBytes(peer.bytessent) }}
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script src="/js/dashboard.js"></script>

</body>

</html>