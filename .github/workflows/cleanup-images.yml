name: Cleanup Untagged Docker Images

on:
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC
  workflow_dispatch:      # Manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete untagged images via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_NAME: btc-node-dashboard
          OWNER: ${{ github.repository_owner }}
        run: |
          # Get all package versions
          versions=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/$OWNER/packages/container/$PACKAGE_NAME/versions?per_page=100")
          
          # Delete untagged versions (no tags array or empty tags)
          echo "$versions" | jq -r '.[] | select(.metadata.container.tags | length == 0) | .id' | while read version_id; do
            echo "Deleting untagged version ID: $version_id"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/users/$OWNER/packages/container/$PACKAGE_NAME/versions/$version_id" || echo "Failed to delete $version_id"
          done
          
          echo "Cleanup completed!"