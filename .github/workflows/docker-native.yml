name: Build Natif Quarkus & Push GHCR

on:
  push:
    # DÃ©clenche le workflow sur les pushes vers la branche 'main'
    branches:
      - main
  workflow_dispatch:

env:
  # DÃ©finir la version de Java Ã  utiliser
  JAVA_VERSION: '21'
  # DÃ©finir le nom de l'image (ghcr.io/<PROPRIETAIRE>/<REPO>)
  IMAGE_FULL_NAME: ghcr.io/${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # Permission essentielle pour pouvoir Ã©crire (push) sur GHCR
      packages: write

    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Configurer Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ” Login sur GitHub Container Registry (GHCR)
        # NÃ©cessaire pour pouvoir 'pousser' l'image
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # Utilise le token fourni par GitHub pour les actions (permission 'packages: write' requise)
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ Build Natif Quarkus & Push vers GHCR
        run: |
          # Le goal 'quarkus:image-push' exÃ©cute implicitement le build natif (-Pnative) 
          # et la crÃ©ation de l'image Docker (quarkus:image-build)
          mvn clean package \
            -Pnative \
            -DskipTests \
            -Dquarkus.container-image.image=${{ env.IMAGE_FULL_NAME }}:latest \
            quarkus:image-push
        # Ajout d'un tag supplÃ©mentaire pour la traÃ§abilitÃ©
      - name: ğŸ”– Tagging avec le SHA et Push du tag
        run: |
          # Tagger l'image qui vient d'Ãªtre crÃ©Ã©e avec le SHA de commit
          docker tag ${{ env.IMAGE_FULL_NAME }}:native ${{ env.IMAGE_FULL_NAME }}:${{ github.sha }}
          # Pousser le tag spÃ©cifique
          docker push ${{ env.IMAGE_FULL_NAME }}:${{ github.sha }}