name: Build Quarkus Native et Dockeriser

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Permet de lancer manuellement le workflow depuis l'interface GitHub
  workflow_dispatch:

jobs:
  native_build_and_deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write # NÃ©cessaire pour pousser vers ghcr.io

    steps:
    
      - name: Checkout du Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Configuration de GraalVM pour le Build Natif
        # Utilisation de 'graalvm' pour contourner le problÃ¨me de 'mandrel'
        uses: actions/setup-java@v4
        with:
          distribution: 'graalvm' 
          java-version: '21' # Version LTS rÃ©cente
          cache: 'maven' 
          
      - name: ğŸ”¨ Compiler en Natif avec Maven Wrapper
        # Utilisation de ./mvnw pour la robustesse de l'environnement CI
        run: |
          ./mvnw package -Pnative -DskipTests
        
      - name: ğŸ‹ Connexion au Registry Docker (GitHub Packages)
        # Connexion Ã  ghcr.io pour le push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ DÃ©finition des Variables d'Image
        id: image_vars
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository }}/mon-app-native
          TAG=${{ github.sha }}
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Construire l'Image Docker Multi-Stage
        # NÃ©cessite un fichier 'src/main/docker/Dockerfile.native' existant
        # Si vous utilisez le plugin QCI, vous n'auriez pas besoin de ce Dockerfile
        # et utiliseriez la commande Maven du plugin.
        run: |
          docker build -f src/main/docker/Dockerfile.native \
                       -t ${{ steps.image_vars.outputs.IMAGE_NAME }}:latest \
                       -t ${{ steps.image_vars.outputs.IMAGE_NAME }}:${{ steps.image_vars.outputs.TAG }} .
          
      - name: â¬†ï¸ Pousser l'Image Docker
        run: |
          docker push ${{ steps.image_vars.outputs.IMAGE_NAME }}:latest
          docker push ${{ steps.image_vars.outputs.IMAGE_NAME }}:${{ steps.image_vars.outputs.TAG }}
