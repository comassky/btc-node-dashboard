name: Build Quarkus Native et Dockeriser

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  native_build_and_deploy:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout du Code
        uses: actions/checkout@v4

      - name: Configuration de GraalVM pour le Build Natif
        # Utilise setup-java pour configurer le JDK et GraalVM.
        # Nous utilisons Mandrel, une distribution support√©e de GraalVM.
        uses: actions/setup-java@v4
        with:
          distribution: 'mandrel'
          java-version: '21'
          cache: 'maven' # Mettre en cache les d√©pendances Maven

      - name: Compiler en Natif avec Maven
        run: |
          # La commande standard pour le build natif Quarkus
          # Le profil '-Pnative' est essentiel
          ./mvnw package -Pnative -DskipTests
        # L'ex√©cutable natif sera cr√©√© dans 'target/' sous le nom 'mon-app-runner' (ou similaire)

      - name: üêã Connexion au Registry Docker (GitHub Packages)
        # N√©cessaire pour pousser l'image finale
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üì¶ Construire et Pousser l'Image Docker
        env:
          IMAGE_NAME: ghcr.io/${{ github.repository }}/native-app
          TAG: ${{ github.sha }}
        run: |
          # 1. Copier le Dockerfile multi-stage n√©cessaire (si vous ne l'avez pas d√©j√†)
          # Si vous utilisez le plugin QCI (Quarkus Container Image), cette √©tape est plus simple.
          
          # Ici, nous utilisons un Dockerfile multi-stage simple (assurez-vous qu'il existe)
          docker build -f src/main/Dockerfile.native \
                       -t ${IMAGE_NAME}:latest \
                       -t ${IMAGE_NAME}:${TAG} .
          
          # Pousser les images vers le GitHub Container Registry
          docker push ${IMAGE_NAME}:latest
          docker push ${IMAGE_NAME}:${TAG}

      - name: ‚úÖ D√©ploiement (Exemple : Utilisation de SSH/Kubernetes/AWS ECR)
        # Cette √©tape d√©pend de votre cible de d√©ploiement (Kubernetes, ECS, VM, etc.)
        run: |
          echo "Image ${IMAGE_NAME}:${TAG} construite et pouss√©e."
          echo "D√©ployez l'application native ici..."
          # Exemple : kubectl apply -f deployment.yaml
          # ou appel √† une API de d√©ploiement