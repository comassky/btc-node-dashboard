name: Build Natif Quarkus & Push GHCR

on:
  push:
    # D√©clenche le workflow sur les pushes vers la branche 'main'
    branches:
      - main
  workflow_dispatch:

env:
  # D√©finir la version de Java √† utiliser
  JAVA_VERSION: '21'
  # D√©finir le nom de l'image (ghcr.io/<PROPRIETAIRE>/<REPO>)
  IMAGE_FULL_NAME: ghcr.io/${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # Permission essentielle pour pouvoir √©crire (push) sur GHCR
      packages: write

    steps:
      - name: üîÑ Checkout du code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Configurer Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: üîê Login sur GitHub Container Registry (GHCR)
        # N√©cessaire pour pouvoir 'pousser' l'image
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # Utilise le token fourni par GitHub pour les actions (permission 'packages: write' requise)
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build Natif Quarkus & Push vers GHCR
        run: |
          # Le goal 'quarkus:image-push' ex√©cute implicitement le build natif (-Pnative) 
          # et la cr√©ation de l'image Docker (quarkus:image-build)
          mvn clean package \
            -Pnative \
            -DskipTests \
            -Dquarkus.container-image.image=${{ env.IMAGE_FULL_NAME }}:native \
            quarkus:image-push
